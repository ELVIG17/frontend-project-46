name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: package-lock.json
    
    - name: Install dependencies
      run: |
        npm ci --no-audit --prefer-offline
    
    - name: Run linter
      run: |
        node node_modules/eslint/bin/eslint.js . --max-warnings=0
    
    - name: Run tests
      run: |
        NODE_OPTIONS=--experimental-vm-modules npx jest
    
    - name: Run tests with coverage
      run: |
        NODE_OPTIONS=--experimental-vm-modules npx jest --coverage
    
    - name: Test CLI functionality
      run: |
        # Test help
        node bin/gendiff.js -h
        # Test version
        node bin/gendiff.js -V
        # Test basic comparison
        node bin/gendiff.js __tests__/__fixtures__/file1.json __tests__/__fixtures__/file2.json
        # Test nested comparison
        node bin/gendiff.js __tests__/__fixtures__/nested1.json __tests__/__fixtures__/nested2.json
        # Test different formats
        node bin/gendiff.js __tests__/__fixtures__/file1.json __tests__/__fixtures__/file2.json --format plain
        node bin/gendiff.js __tests__/__fixtures__/file1.json __tests__/__fixtures__/file2.json --format json